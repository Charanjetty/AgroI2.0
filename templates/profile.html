{% extends "base.html" %}
{% block title %}My Profile - AgroIntelligence{% endblock %}

{% block head %}
<style>
    .profile-header {
        background: transparent;
        padding-top: 4rem;
        padding-bottom: 6rem;
        color: white;
        margin-bottom: -4rem;
    }

    .profile-card {
        background: white;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }

    .avatar-container {
        width: 120px;
        height: 120px;
        background: white;
        border-radius: 50%;
        padding: 4px;
        margin: 0 auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    .avatar-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: #cbd5e1;
    }

    .nav-tabs {
        display: flex;
        border-bottom: 1px solid #e2e8f0;
        padding: 0 2rem;
    }

    .nav-tab {
        padding: 1rem 1.5rem;
        font-weight: 600;
        color: #64748b;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .nav-tab:hover {
        color: #16a34a;
    }

    .nav-tab.active {
        color: #16a34a;
        border-bottom-color: #16a34a;
    }

    .form-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #475569;
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: #16a34a;
        box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }

    .stat-card {
        background: #f8fafc;
        padding: 1.5rem;
        border-radius: 16px;
        text-align: center;
        border: 1px solid #e2e8f0;
    }
</style>
{% endblock %}

{% block content %}
<div class="-mx-4 -mt-10">
    <!-- Header -->
    <div class="profile-header text-center">
        <h1 class="text-3xl font-bold mb-2">My Profile</h1>
        <p class="text-green-100">Manage your account and farm settings</p>
    </div>

    <div class="max-w-4xl mx-auto px-4">
        <div class="profile-card">
            <div class="p-8 pb-0 text-center">
                <div class="avatar-container -mt-20 mb-4">
                    <div class="avatar-img">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-slate-900">{{ current_user.full_name or current_user.username }}</h2>
                <p class="text-slate-500 mb-6">
                    <i class="fas fa-map-marker-alt mr-1"></i> {{ current_user.district or 'No district set' }}
                </p>

                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="stat-card">
                        <div class="text-2xl font-bold text-green-600">{{ prediction_count }}</div>
                        <div class="text-xs text-slate-500 font-semibold uppercase tracking-wide">Predictions</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-2xl font-bold text-blue-600">{{ current_user.farm_size or 0 }}</div>
                        <div class="text-xs text-slate-500 font-semibold uppercase tracking-wide">Acres</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-2xl font-bold text-purple-600">{{ days_member }}</div>
                        <div class="text-xs text-slate-500 font-semibold uppercase tracking-wide">Days Member</div>
                    </div>
                </div>
            </div>

            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('personal')">Personal Details</div>
                <div class="nav-tab" onclick="switchTab('farm')">Farm Details</div>
                <div class="nav-tab" onclick="switchTab('security')">Security</div>
            </div>

            <div class="p-8">
                <form method="POST" action="{{ url_for('update_profile') }}">
                    <!-- Personal Tab -->
                    <div id="tab-personal" class="tab-content">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" name="full_name" value="{{ current_user.full_name or '' }}"
                                    class="form-input" placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" value="{{ current_user.email }}"
                                    class="form-input bg-slate-50 text-slate-500" readonly>
                                <p class="text-xs text-slate-400 mt-1">Email cannot be changed</p>
                            </div>
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" name="phone" value="{{ current_user.phone or '' }}" class="form-input"
                                    placeholder="+91 XXXXX XXXXX">
                            </div>
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" value="{{ current_user.username }}"
                                    class="form-input bg-slate-50 text-slate-500" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Farm Tab -->
                    <div id="tab-farm" class="tab-content hidden">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label>District</label>
                                <select name="district" class="form-input" id="districtSelect">
                                    <option value="{{ current_user.district }}">{{ current_user.district or 'Select
                                        District' }}</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Farm Size (Acres)</label>
                                <input type="number" name="farm_size" value="{{ current_user.farm_size or '' }}"
                                    step="0.1" class="form-input" placeholder="e.g. 5.5">
                            </div>
                            <div class="form-group md:col-span-2">
                                <label>Primary Crops</label>
                                <input type="text" name="primary_crops" value="{{ current_user.primary_crops or '' }}"
                                    class="form-input" placeholder="e.g. Rice, Cotton, Chillies">
                            </div>
                        </div>
                    </div>

                    <!-- Security Tab -->
                    <div id="tab-security" class="tab-content hidden">
                        <div class="max-w-md mx-auto">
                            <div class="form-group mb-4">
                                <label>Current Password</label>
                                <input type="password" name="current_password" class="form-input"
                                    placeholder="Enter to confirm changes">
                            </div>
                            <div class="border-t border-slate-200 my-6 pt-6">
                                <h3 class="font-bold text-slate-900 mb-4">Change Password</h3>
                                <div class="form-group mb-4">
                                    <label>New Password</label>
                                    <input type="password" name="new_password" class="form-input"
                                        placeholder="Leave blank to keep current">
                                </div>
                                <div class="form-group">
                                    <label>Confirm New Password</label>
                                    <input type="password" name="confirm_new_password" class="form-input"
                                        placeholder="Confirm new password">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-100 flex justify-end">
                        <button type="submit"
                            class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold transition shadow-lg shadow-green-600/20">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        // Show selected tab
        document.getElementById('tab-' + tabName).classList.remove('hidden');

        // Update nav styling
        document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    }

    // Load districts if not already loaded
    fetch('/get_district_names')
        .then(res => res.json())
        .then(districts => {
            const select = document.getElementById('districtSelect');
            const current = "{{ current_user.district }}";

            districts.forEach(district => {
                if (district !== current) {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    select.appendChild(option);
                }
            });
        });
</script>
{% endblock %}