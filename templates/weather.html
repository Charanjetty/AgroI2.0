{% extends "base.html" %}
{% block title %}AgroIntelligence · Weather Intelligence{% endblock %}
{% block head %}
<style>
  .stat-card {
    background: linear-gradient(120deg, #f7fee7, #dcfce7);
    border-radius: 1.5rem;
  }

  .timeline-item {
    border-left: 3px solid #22c55e;
    padding-left: 1rem;
    margin-left: 0.5rem;
  }
</style>
{% endblock %}
{% block content %}
<section class="glass rounded-3xl p-6 md:p-10 space-y-6">
  <div class="grid md:grid-cols-2 gap-6">
    <div>
      <p class="text-sm uppercase tracking-widest text-green-600 font-semibold">
        Weather interaction center
      </p>
      <h2 class="text-3xl font-bold text-slate-900 mt-2">
        Monitor the sky before you sow.
      </h2>
      <p class="text-slate-600 mt-3">
        Select any Andhra Pradesh district to view live weather, 12-hour
        forecasts, and agronomy hints. The same engine powers Auto Mode on the
        dashboard.
      </p>
      <div class="mt-6 bg-white rounded-3xl shadow overflow-hidden">
        <img src="https://images.unsplash.com/photo-1500937386664-56d1dfef3854?auto=format&fit=crop&w=800&q=60"
          alt="Farmland" class="w-full h-48 object-cover" />
      </div>
    </div>
    <div class="glass rounded-3xl shadow p-6 space-y-4">
      <label class="text-sm font-semibold text-slate-600">Choose district</label>
      <select id="weather-district"
        class="w-full rounded-2xl border border-slate-200 p-3 focus:ring-2 focus:ring-green-500"></select>
      <button id="refresh-weather"
        class="w-full bg-green-600 text-white font-semibold py-3 rounded-2xl shadow hover:bg-green-700 transition">
        Update weather
      </button>
      <p class="text-xs text-slate-400">
        Powered by Open-Meteo · Updated every request
      </p>
    </div>
  </div>

  <div class="grid md:grid-cols-3 gap-4" id="weather-stats">
    <div class="stat-card p-6 text-slate-800">
      <p class="text-xs uppercase tracking-widest text-green-700">
        Temperature
      </p>
      <p class="text-3xl font-bold" id="stat-temp">-- °C</p>
      <p class="text-sm text-slate-500" id="stat-temp-time">--</p>
    </div>
    <div class="stat-card p-6 text-slate-800">
      <p class="text-xs uppercase tracking-widest text-green-700">
        Wind speed
      </p>
      <p class="text-3xl font-bold" id="stat-wind">-- km/h</p>
      <p class="text-sm text-slate-500">Surface level</p>
    </div>
    <div class="stat-card p-6 text-slate-800">
      <p class="text-xs uppercase tracking-widest text-green-700">
        Advisory
      </p>
      <p class="text-base" id="stat-tip">
        Select a district to get irrigation tips.
      </p>
    </div>
  </div>
</section>

<section class="glass rounded-3xl shadow p-6 space-y-6">
  <div class="flex items-center justify-between flex-wrap gap-2">
    <div>
      <p class="text-sm font-semibold text-green-600 uppercase tracking-widest">
        Visual forecast
      </p>
      <h3 class="text-2xl font-bold text-slate-900">
        12-hour temperature & humidity trend
      </h3>
    </div>
    <div class="text-sm text-slate-500" id="weather-updated">--</div>
  </div>
  <canvas id="tempChart" height="140"></canvas>
</section>

<section class="glass rounded-3xl shadow p-6">
  <h3 class="text-xl font-semibold text-slate-900 mb-4">
    Hourly breakdown
  </h3>
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm text-left">
      <thead>
        <tr class="text-slate-500 uppercase tracking-wide text-xs">
          <th class="py-2 pr-6">Time</th>
          <th class="py-2 pr-6">Temp (°C)</th>
          <th class="py-2 pr-6">Humidity (%)</th>
          <th class="py-2 pr-6">Precip (mm)</th>
        </tr>
      </thead>
      <tbody id="hourly-table" class="text-slate-700"></tbody>
    </table>
  </div>
</section>

<section class="glass rounded-3xl p-6 space-y-4">
  <h3 class="text-xl font-semibold text-slate-900">
    Field-ready action plan
  </h3>
  <div id="advice-timeline" class="space-y-3">
    <div class="timeline-item">
      <p class="font-semibold">Monitor weather every morning</p>
      <p class="text-sm text-slate-500">
        Combine this page with Auto Mode to refresh guidance before irrigating.
      </p>
    </div>
    <div class="timeline-item">
      <p class="font-semibold">Use hourly humidity for spray timing</p>
      <p class="text-sm text-slate-500">
        Plan pesticide/fungicide sprays when humidity dips below 70% to reduce
        wash-off.
      </p>
    </div>
  </div>
</section>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const districtSelect = document.getElementById("weather-district");
  const refreshBtn = document.getElementById("refresh-weather");
  const statTemp = document.getElementById("stat-temp");
  const statWind = document.getElementById("stat-wind");
  const statTip = document.getElementById("stat-tip");
  const statTime = document.getElementById("stat-temp-time");
  const updatedText = document.getElementById("weather-updated");
  const hourlyTable = document.getElementById("hourly-table");
  let tempChart;

  async function fetchJson(url) {
    const res = await fetch(url);
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || "Unable to load weather.");
    }
    return res.json();
  }

  async function loadDistricts() {
    const districts = await fetchJson("/get_district_names");
    districts.forEach((district, idx) => {
      const option = document.createElement("option");
      option.value = district;
      option.textContent = district;
      if (idx === 0) option.selected = true;
      districtSelect.appendChild(option);
    });
  }

  function renderStats(weather) {
    if (!weather || !weather.current) {
      statTemp.textContent = "-- °C";
      statWind.textContent = "-- km/h";
      statTip.textContent = "Weather feed unavailable.";
      statTime.textContent = "";
      updatedText.textContent = "";
      return;
    }
    const current = weather.current;
    statTemp.textContent = `${current.temperature ?? "--"} °C`;
    statWind.textContent = `${current.windspeed ?? "--"} km/h`;
    statTime.textContent = current.time
      ? `Updated: ${new Date(current.time).toLocaleString()}`
      : "";
    updatedText.textContent = statTime.textContent;
    statTip.textContent =
      current.temperature > 32
        ? "Plan irrigation for dawn/evening to reduce evap losses."
        : "Mild conditions—ideal for fertilizer topdressing.";
  }

  function renderHourlyChart(hourly = []) {
    const labels = hourly.map((entry) =>
      new Date(entry.time).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
    );
    const temps = hourly.map((entry) => entry.temperature);
    const humidity = hourly.map((entry) => entry.humidity);
    if (tempChart) {
      tempChart.destroy();
    }
    const ctx = document.getElementById("tempChart").getContext("2d");
    tempChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Temperature °C",
            data: temps,
            borderColor: "#16a34a",
            backgroundColor: "rgba(34,197,94,0.2)",
            tension: 0.4,
            fill: true,
          },
          {
            label: "Humidity %",
            data: humidity,
            borderColor: "#0ea5e9",
            backgroundColor: "rgba(14,165,233,0.15)",
            tension: 0.4,
            fill: true,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: true,
          },
        },
        scales: {
          y: {
            beginAtZero: false,
          },
        },
      },
    });
  }

  function renderHourlyTable(hourly = []) {
    hourlyTable.innerHTML = "";
    hourly.forEach((entry) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="py-2 pr-6">${new Date(entry.time).toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
      })}</td>
        <td class="py-2 pr-6">${entry.temperature ?? "--"}</td>
        <td class="py-2 pr-6">${entry.humidity ?? "--"}</td>
        <td class="py-2 pr-6">${entry.precipitation ?? "--"}</td>
      `;
      hourlyTable.appendChild(row);
    });
  }

  async function refreshWeather() {
    const district = districtSelect.value;
    if (!district) return;
    try {
      refreshBtn.disabled = true;
      refreshBtn.textContent = "Loading...";
      const data = await fetchJson(`/api/weather/${encodeURIComponent(district)}`);
      renderStats(data);
      renderHourlyChart(data.hourly);
      renderHourlyTable(data.hourly);
    } catch (error) {
      statTip.textContent = error.message;
    } finally {
      refreshBtn.disabled = false;
      refreshBtn.textContent = "Update weather";
    }
  }

  async function init() {
    await loadDistricts();
    await refreshWeather();
    refreshBtn.addEventListener("click", refreshWeather);
    districtSelect.addEventListener("change", refreshWeather);
  }

  init();
</script>
{% endblock %}